<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>קו {{ line }} — יציאות קרובות</title>

  <style>
    body { font-family: system-ui, Arial; margin: 24px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .muted { color: #666; font-size: 13px; }
    ul { margin: 10px 0 0; padding: 0 18px; }
    li { margin: 6px 0; }
    .pill { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; color: #333; margin-inline-start: 8px; }

    .section { margin-top: 18px; }
    #map { height: 420px; border-radius: 12px; border: 1px solid #ddd; overflow: hidden; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap: wrap; }
  </style>

  <!-- Leaflet (מפה) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head>

<body>
  <h1>קו {{ line }} — יציאות קרובות</h1>
  <p class="muted">תחנות: {{ stops | join(", ") }} · רענון אוטומטי כל 20 שניות</p>

  <!-- מפה -->
  <div class="section">
    <div class="row">
      <h2 style="margin:0;">מיקום אוטובוסים על המפה</h2>
      <div id="mapStatus" class="muted"></div>
    </div>
    <div id="map"></div>
  </div>

  <!-- יציאות -->
  <div class="section">
    <div id="status" class="muted"></div>
    <div id="cards" class="grid"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const LINE = "{{ line }}";

    // עוזר להציג הודעות שגיאה קצרות
    function shortText(x, maxLen = 160) {
      const s = String(x ?? "");
      return s.length > maxLen ? s.slice(0, maxLen) + "…" : s;
    }

    // ===== חלק 1: יציאות מהתחנות =====
    async function refreshDepartures() {
      const status = document.getElementById("status");
      const cards = document.getElementById("cards");
      status.textContent = "טוען יציאות…";

      try {
        const res = await fetch("/api/departures", { cache: "no-store" });

        if (!res.ok) {
          const txt = await res.text();
          status.textContent = `שגיאה מהשרת (${res.status}): ${shortText(txt)}`;
          return;
        }

        const data = await res.json();

        cards.innerHTML = "";
        (data.results || []).forEach(r => {
          const el = document.createElement("div");
          el.className = "card";

          const header = `
            <div class="title">${r.stop_name || "תחנה"} <span class="pill">#${r.stop_code}</span></div>
            <div class="muted">עודכן: ${r.updated_at}</div>
          `;

          let list = "";
          if (!r.departures || r.departures.length === 0) {
            list = `<p>לא נמצאו יציאות קרובות לקו ${LINE} כרגע.</p>`;
          } else {
            const items = r.departures.map(d =>
              `<li>${d.time_hhmm} (בעוד ~${d.in_minutes} דק׳) ${d.is_realtime ? '<span class="pill">Realtime</span>' : ''}</li>`
            ).join("");
            list = `<ul>${items}</ul>`;
          }

          el.innerHTML = header + list;
          cards.appendChild(el);
        });

        if (data.errors && data.errors.length) {
          status.textContent = "חלק מהתחנות נכשלו: " + data.errors.map(e => `${e.stop_code}: ${e.error}`).join(" | ");
        } else {
          status.textContent = "";
        }
      } catch (e) {
        status.textContent = "שגיאה בטעינת יציאות: " + shortText(e);
      }
    }

    // ===== חלק 2: מפה + מיקומי אוטובוסים =====
    const mapStatus = document.getElementById("mapStatus");

    // מרכז ברירת מחדל (ישראל). ננסה לעשות fit אוטומטי אם יש אוטובוסים.
    const map = L.map("map").setView([32.0853, 34.7818], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap",
    }).addTo(map);

    const markers = new Map(); // key -> marker
    let didFitOnce = false;

    async function refreshVehicles() {
      mapStatus.textContent = "טוען מיקום אוטובוסים…";

      try {
        const res = await fetch(`/api/vehicles?line=${encodeURIComponent(LINE)}`, { cache: "no-store" });

        if (!res.ok) {
          const txt = await res.text();
          mapStatus.textContent = `שגיאה מהשרת (${res.status}): ${shortText(txt)}`;
          return;
        }

        const json = await res.json();

        // אם השרת החזיר errors (מה-main.py), נציג למשתמש
        const apiErrors = (json.errors || []);
        const candidatesTried = json.candidates_tried || json.candidates || [];

        const vehicles = json.vehicles || [];
        const seen = new Set();
        const latlngs = [];

        for (const v of vehicles) {
          const key = v.vehicle_ref || `${v.lat},${v.lon}`;
          seen.add(key);

          const latlng = [v.lat, v.lon];
          latlngs.push(latlng);

          if (!markers.has(key)) {
            const m = L.marker(latlng).addTo(map);

            const popup = [
              `קו ${LINE}`,
              v.recorded_at_time ? `דיווח: ${v.recorded_at_time}` : "",
              v.agency_name ? `מפעיל: ${v.agency_name}` : "",
              v.route_long_name ? `מסלול: ${v.route_long_name}` : "",
            ].filter(Boolean).join("<br>");

            m.bindPopup(popup);
            markers.set(key, m);
          } else {
            markers.get(key).setLatLng(latlng);
          }
        }

        // להסיר מרקרים שלא קיימים יותר
        for (const [key, marker] of markers.entries()) {
          if (!seen.has(key)) {
            map.removeLayer(marker);
            markers.delete(key);
          }
        }

        if (vehicles.length === 0) {
          // אם יש שגיאות API, נציג אותן כדי שתדע אם זה Timeout או משהו אחר
          if (apiErrors.length) {
            mapStatus.textContent = `אין מיקומים כרגע (ייתכן ש-Stride איטי): ${shortText(apiErrors.join(" | "))}`;
          } else if (candidatesTried.length === 0) {
            mapStatus.textContent = `לא נמצאו התאמות לקו ${LINE} בנתוני GTFS (candidates ריק).`;
          } else {
            mapStatus.textContent = `לא נמצאו מיקומים חיים לקו ${LINE} כרגע.`;
          }
        } else {
          mapStatus.textContent = `נמצאו ${vehicles.length} אוטובוסים (עודכן עכשיו).`;

          // רק פעם אחת לעשות zoom מתאים, כדי לא “להקפיץ” את המשתמש כל הזמן
          if (!didFitOnce && latlngs.length >= 1) {
            didFitOnce = true;
            const bounds = L.latLngBounds(latlngs);
            map.fitBounds(bounds, { padding: [30, 30] });
          }
        }
      } catch (e) {
        mapStatus.textContent = "שגיאה בטעינת מיקומים: " + shortText(e);
      }
    }

    // init
    refreshDepartures();
    refreshVehicles();

    setInterval(refreshDepartures, 20000);
    setInterval(refreshVehicles, 15000);
  </script>
</body>
</html>
